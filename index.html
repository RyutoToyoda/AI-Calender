<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI Calendar - Ultra Modern Returns</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --glass-border: rgba(255, 255, 255, 0.4); --glass-bg: rgba(255, 255, 255, 0.65); }
        body { 
            font-family: 'Plus Jakarta Sans', 'Noto Sans JP', sans-serif; 
            overflow: hidden; 
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ガラス効果 */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        /* カレンダーグリッド */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 12px; 
            padding: 12px;
        }

        /* 日付カード */
        .day-card { 
            min-height: 90px;
            height: calc((100vh - 140px) / 5.5); 
            display: flex;
            flex-direction: column; 
            background: rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            padding: 8px; 
            position: relative;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid transparent;
            cursor: pointer;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .calendar-grid { gap: 6px; padding: 6px; }
            .day-card { border-radius: 10px; height: calc((100vh - 220px) / 6); min-height: 70px; padding: 4px; }
        }

        .day-card:hover { 
            background: rgba(255, 255, 255, 0.9); 
            transform: translateY(-4px); 
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }
        
        .day-card.selected { 
            background: #fff;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
        }
        
        .today { background: rgba(255, 255, 255, 0.85); }
        .today .day-num { 
            background: linear-gradient(135deg, #8b5cf6, #6366f1); 
            color: white; 
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.4);
        }

        .holiday .day-num { color: #ef4444; }
        .holiday { background: rgba(254, 242, 242, 0.6); }

        .day-num {
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px; margin-bottom: 4px;
            font-weight: 700; color: #64748b;
            font-size: 0.9rem;
        }

        /* 予定チップ */
        .event-pill { 
            font-size: 0.65rem; 
            padding: 3px 8px; 
            border-radius: 20px; 
            margin-bottom: 3px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            background: #f3e8ff; 
            color: #6b21a8; 
            font-weight: 600;
            border: 1px solid #e9d5ff;
            transition: transform 0.2s;
        }
        .event-pill:hover { transform: scale(1.02); }

        /* スイッチなどのUIパーツ */
        .toggle-checkbox:checked { right: 0; border-color: #6366f1; }
        .toggle-checkbox:checked + .toggle-label { background-color: #6366f1; }
        .toggle-checkbox { right: 50%; border-color: #cbd5e1; transition: all 0.3s; }
        
        .custom-scroll::-webkit-scrollbar { width: 0px; background: transparent; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-screen w-screen flex flex-col md:flex-row overflow-hidden text-slate-800">

    <!-- Sidebar (PC) / Bottom Nav (Mobile) -->
    <nav class="glass z-50 flex md:flex-col justify-between items-center p-2 md:py-6 md:px-3 fixed md:relative bottom-0 w-full md:w-24 md:h-full border-t md:border-t-0 md:border-r border-white/40 shadow-xl order-2 md:order-1 h-16">
        <div class="hidden md:flex bg-white/80 w-12 h-12 rounded-2xl items-center justify-center text-indigo-600 shadow-sm mb-8">
            <i class="fas fa-calendar-check text-2xl"></i>
        </div>

        <div class="flex md:flex-col gap-1 md:gap-4 w-full md:w-auto justify-around md:justify-start">
            <button id="navCalendar" class="p-3 rounded-xl bg-indigo-600 text-white shadow-lg shadow-indigo-200 transition transform active:scale-95 flex flex-col items-center">
                <i class="fas fa-calendar-alt text-lg"></i>
            </button>
            <button id="openAiModal" class="p-3 rounded-xl text-slate-500 hover:bg-white/50 hover:text-indigo-600 transition flex flex-col items-center disabled:opacity-40" disabled>
                <i class="fas fa-wand-magic-sparkles text-lg"></i>
            </button>
            <button id="openSettings" class="p-3 rounded-xl text-slate-500 hover:bg-white/50 hover:text-indigo-600 transition flex flex-col items-center">
                <i class="fas fa-cog text-lg"></i>
            </button>
        </div>

        <div class="hidden md:block flex-grow"></div>

        <div id="authArea" class="relative">
            <button id="loginBtn" class="p-2 text-xs font-bold bg-white rounded-lg shadow-sm text-indigo-600 md:hidden">LOGIN</button>
            <div id="userProfile" class="hidden flex-col gap-4 items-center">
                <button id="logoutBtn" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-red-50 hover:text-red-500 transition shadow-sm"><i class="fas fa-power-off text-sm"></i></button>
                <img id="userPhoto" src="" class="w-10 h-10 rounded-full border-2 border-white shadow-md cursor-pointer" alt="User">
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col md:flex-row relative h-full w-full order-1 md:order-2 overflow-hidden">
        
        <!-- Calendar Section -->
        <div id="calendarArea" class="flex-grow flex flex-col h-full relative z-0">
            <!-- Header -->
            <div class="px-6 pt-6 pb-2 flex items-center justify-between">
                <div>
                    <div class="flex items-center gap-3">
                        <h2 class="text-3xl font-800 text-slate-800 tracking-tight drop-shadow-sm">Calendar</h2>
                        <span id="activeModelBadge" class="text-[10px] font-bold bg-white/50 px-2 py-1 rounded-lg border border-white/60">...</span>
                    </div>
                    <p id="currentMonthDisplay" class="text-lg font-bold text-indigo-900/60 uppercase tracking-widest mt-1 ml-1">Loading...</p>
                </div>
                <div class="glass rounded-2xl p-1 flex shadow-sm">
                    <button id="prevBtn" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/50 transition"><i class="fas fa-chevron-left text-slate-600"></i></button>
                    <button id="nextBtn" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/50 transition"><i class="fas fa-chevron-right text-slate-600"></i></button>
                </div>
            </div>

            <!-- Login Prompt -->
            <div id="loginPrompt" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-white/30 backdrop-blur-md hidden">
                <div class="glass p-10 rounded-3xl shadow-2xl flex flex-col items-center text-center max-w-sm mx-4">
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-lg text-white">
                        <i class="fas fa-lock text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Welcome Back</h2>
                    <p class="text-sm text-slate-600 mb-6">ログインして全ての機能を利用しましょう。</p>
                    <button id="loginBtnLarge" class="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold shadow-xl hover:scale-105 transition transform w-full">Googleでログイン</button>
                    <div id="authErrorMessage" class="hidden mt-4 p-3 bg-red-100/80 text-red-600 text-xs text-left rounded-xl border border-red-200"></div>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div id="calendarWrapper" class="flex-grow p-2 md:p-4 overflow-hidden flex flex-col hidden">
                <div class="grid grid-cols-7 gap-2 mb-2 px-2 text-center">
                    <div class="text-xs font-bold text-red-400">SUN</div>
                    <div class="text-xs font-bold text-slate-500">MON</div>
                    <div class="text-xs font-bold text-slate-500">TUE</div>
                    <div class="text-xs font-bold text-slate-500">WED</div>
                    <div class="text-xs font-bold text-slate-500">THU</div>
                    <div class="text-xs font-bold text-slate-500">FRI</div>
                    <div class="text-xs font-bold text-blue-400">SAT</div>
                </div>
                <div id="calendarGrid" class="calendar-grid overflow-y-auto custom-scroll h-full"></div>
            </div>
        </div>

        <!-- Right Sidebar (Detail) -->
        <aside id="dayDetailPanel" class="glass w-full md:w-[400px] border-l border-white/50 shadow-2xl z-20 flex flex-col transition-transform duration-500 transform translate-y-full md:translate-y-0 md:translate-x-full fixed md:absolute top-0 right-0 h-full rounded-t-[2.5rem] md:rounded-l-[2.5rem] md:rounded-tr-none overflow-hidden">
            <div class="p-8 border-b border-white/40 flex items-center justify-between bg-white/30">
                <div>
                    <h3 id="detailDateDisplay" class="text-3xl font-800 text-slate-800 tracking-tight">Select</h3>
                    <p id="detailDayOfWeek" class="text-sm font-bold text-indigo-600 uppercase tracking-widest mt-1 opacity-80">--</p>
                </div>
                <button id="closeDetail" class="w-10 h-10 rounded-full bg-white/50 hover:bg-white flex items-center justify-center transition shadow-sm"><i class="fas fa-times text-slate-500"></i></button>
            </div>

            <div id="detailEventList" class="flex-grow p-6 space-y-4 overflow-y-auto custom-scroll bg-white/20">
                <div class="flex flex-col items-center justify-center h-full text-slate-400">
                    <i class="fas fa-hand-pointer text-4xl mb-4 opacity-30"></i>
                    <p class="text-sm font-bold opacity-70">日付を選択してください</p>
                </div>
            </div>

            <div class="p-6 bg-white/40 border-t border-white/40 safe-pb backdrop-blur-md">
                <button id="manualAddBtn" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-xl hover:bg-slate-800 transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> 新しい予定を追加
                </button>
            </div>
        </aside>
    </main>

    <!-- Modals -->
    <!-- AI Modal -->
    <div id="aiModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-md flex items-center justify-center z-50 hidden p-4 transition-opacity opacity-0 pointer-events-none">
        <div class="glass bg-white/90 rounded-[2.5rem] w-full max-w-lg p-8 shadow-2xl transform scale-95 transition-transform">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-800">AI解析</h3>
                <button id="closeAiModal" class="w-10 h-10 rounded-full hover:bg-slate-100 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="dropZone" class="border-3 border-dashed border-indigo-200 rounded-[2rem] p-10 text-center hover:border-indigo-500 hover:bg-indigo-50/50 transition cursor-pointer relative overflow-hidden group">
                <input type="file" id="fileInput" class="hidden" accept="image/*">
                <i class="fas fa-cloud-upload-alt text-5xl text-indigo-400 mb-4 group-hover:scale-110 transition duration-300"></i>
                <p class="text-lg font-bold text-slate-700">Upload Image</p>
            </div>
            <div id="previewArea" class="mt-6 hidden text-center">
                <img id="imagePreview" src="" class="rounded-2xl w-full max-h-56 object-contain border-4 border-white shadow-lg">
            </div>
            <div class="mt-8 flex gap-3">
                <button id="cancelUpload" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition">キャンセル</button>
                <button id="processAiBtn" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg disabled:opacity-50 transition" disabled>解析開始</button>
            </div>
        </div>
    </div>

    <!-- Event Form Modal -->
    <div id="eventFormModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-md flex items-center justify-center z-50 hidden p-4 transition-opacity opacity-0 pointer-events-none">
        <div class="glass bg-white/90 rounded-[2.5rem] w-full max-w-lg p-8 shadow-2xl transform scale-95 transition-transform">
            <h3 class="text-xl font-bold mb-6">予定の編集</h3>
            <form id="eventForm" class="space-y-4">
                <input type="hidden" id="formEventId">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-2">タイトル</label>
                    <input type="text" id="formTitle" required class="w-full px-5 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-indigo-500 font-bold">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-2">日付</label>
                        <input type="date" id="formDate" required class="w-full px-5 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-2">時刻</label>
                        <input type="time" id="formTime" class="w-full px-5 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-indigo-500">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-2">メモ</label>
                    <textarea id="formDescription" rows="3" class="w-full px-5 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-indigo-500 resize-none"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" id="closeEventForm" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition">キャンセル</button>
                    <button type="submit" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-md flex items-center justify-center z-50 hidden p-4 transition-opacity opacity-0 pointer-events-none">
        <div class="glass bg-white/90 rounded-[2.5rem] w-full max-w-md p-8 shadow-2xl">
            <h3 class="text-xl font-bold mb-6">設定</h3>
            <div class="space-y-5">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-2">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full px-5 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-indigo-500 font-mono text-sm">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-2">Model</label>
                    <div class="flex gap-2">
                        <select id="modelSelect" class="flex-grow px-5 py-3 bg-white/50 border border-slate-200 rounded-xl font-bold text-sm outline-none focus:border-indigo-500">
                            <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                            <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
                        </select>
                        <button id="discoverBtn" class="bg-white text-indigo-600 w-12 rounded-xl border border-slate-200 hover:bg-indigo-50"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <div class="flex items-center justify-between px-2">
                    <label class="text-sm font-bold text-slate-700">通知機能</label>
                    <div class="relative inline-block w-12 mr-2 align-middle select-none">
                        <input type="checkbox" id="notificationToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="notificationToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button id="closeSettings" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition">閉じる</button>
                    <button id="saveSettings" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loadingOverlay" class="fixed inset-0 loading-overlay flex items-center justify-center hidden">
        <div class="glass bg-white/80 px-8 py-6 rounded-3xl shadow-2xl flex flex-col items-center">
            <i class="fas fa-circle-notch spinner text-3xl text-indigo-600 mb-3"></i>
            <p id="loadingMessage" class="text-sm font-bold text-slate-700">Processing...</p>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-xl translate-y-[-150%] opacity-0 transition-all duration-300 z-[100] flex items-center space-x-3 min-w-[300px] bg-slate-900 text-white border border-slate-700">
        <div id="notifyIcon"></div>
        <p id="notifyText" class="text-sm font-bold"></p>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA9MeRV2VefKb5cOJLzegq3U6EsBEB2axg",
        authDomain: "my-ai-calender-68d05.firebaseapp.com",
        projectId: "my-ai-calender-68d05",
        storageBucket: "my-ai-calender-68d05.firebasestorage.app",
        messagingSenderId: "591169343842",
        appId: "1:591169343842:web:4345e3fdff52d4b5cadc3b"
    };
    const appId = "calendar-ultra-v21";

    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);
    const provider = new GoogleAuthProvider();

    let user = null, events = [], currentDate = new Date(), selectedDateStr = null, unsubscribe = null;
    let geminiKey = localStorage.getItem('v21_key') || "", geminiModel = localStorage.getItem('v21_model') || "gemini-1.5-flash";
    let notificationsEnabled = localStorage.getItem('v21_notify') === 'true';

    const getEl = (id) => document.getElementById(id);
    const toggleClass = (id, cls, condition) => getEl(id).classList.toggle(cls, condition);
    const showModal = (id) => { const m = getEl(id); m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0', 'pointer-events-none'); m.children[0].classList.remove('scale-95'); }, 10); };
    const hideModal = (id) => { const m = getEl(id); m.classList.add('opacity-0', 'pointer-events-none'); m.children[0].classList.add('scale-95'); setTimeout(() => m.classList.add('hidden'), 300); };

    // --- Holiday Logic ---
    function getHolidayName(date) {
        const y = date.getFullYear(), m = date.getMonth() + 1, d = date.getDate(), w = date.getDay();
        if (m==1 && d==1) return "元日";
        if (m==2 && d==11) return "建国記念の日";
        if (m==2 && d==23) return "天皇誕生日";
        if (m==4 && d==29) return "昭和の日";
        if (m==5 && d==3) return "憲法記念日";
        if (m==5 && d==4) return "みどりの日";
        if (m==5 && d==5) return "こどもの日";
        if (m==8 && d==11) return "山の日";
        if (m==11 && d==3) return "文化の日";
        if (m==11 && d==23) return "勤労感謝の日";
        const nth = Math.floor((d - 1) / 7) + 1;
        if (m==1 && nth==2 && w==1) return "成人の日";
        if (m==7 && nth==3 && w==1) return "海の日";
        if (m==9 && nth==3 && w==1) return "敬老の日";
        if (m==10 && nth==2 && w==1) return "スポーツの日";
        return null;
    }

    // --- Notification ---
    function checkNotifications() {
        if (!notificationsEnabled || !user) return;
        const now = new Date();
        const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        // (省略: 前回の通知ロジックをそのまま使用)
    }
    function requestNotifyPermission() {
        if (!('Notification' in window)) return;
        Notification.requestPermission().then(p => {
            notificationsEnabled = (p === 'granted');
            localStorage.setItem('v21_notify', notificationsEnabled);
            getEl('notificationToggle').checked = notificationsEnabled;
        });
    }
    setInterval(checkNotifications, 60000);

    // --- Auth & Sync ---
    onAuthStateChanged(auth, (u) => {
        user = u; updateUI();
        if (user) syncData();
        else { if (unsubscribe) unsubscribe(); renderCalendar(); }
    });

    function updateUI() {
        const loggedIn = !!user;
        toggleClass('loginPrompt', 'hidden', loggedIn);
        toggleClass('calendarWrapper', 'hidden', !loggedIn);
        getEl('openAiModal').disabled = !loggedIn;
        toggleClass('loginBtn', 'hidden', loggedIn);
        toggleClass('userProfile', 'hidden', !loggedIn);
        if (user) getEl('userPhoto').src = user.photoURL;
        getEl('activeModelBadge').textContent = geminiModel;
        getEl('notificationToggle').checked = notificationsEnabled;
    }

    function syncData() {
        if (!user) return;
        unsubscribe = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'events'), (snap) => {
            events = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderCalendar();
            if (selectedDateStr) updateDayDetail(selectedDateStr);
        }, (error) => {
            if(error.code === 'auth/unauthorized-domain') {
                const e = getEl('authErrorMessage');
                e.innerHTML = "エラー: Firebaseコンソールでこのドメインを許可してください。";
                e.classList.remove('hidden');
            }
        });
    }

    // --- AI ---
    async function analyzeImage(base64) {
        if (!geminiKey) return showNotify("APIキーを設定してください", "error");
        setLoading(true, "Analyzing...");
        const prompt = `画像からカレンダー予定を抽出しJSON形式で返してください: [{"title": "件名", "date": "YYYY-MM-DD", "time": "HH:mm", "description": ""}]。`;
        try {
            const path = geminiModel.startsWith('models/') ? geminiModel : `models/${geminiModel}`;
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/${path}:generateContent?key=${geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64.split(',')[1] } }] }] })
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            const items = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```json|```/g, "").trim());
            for (const item of items) if (item.title && item.date) await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'events'), { ...item, createdAt: serverTimestamp() });
            showNotify(`${items.length}件登録しました`, "success");
            hideModal('aiModal');
        } catch (err) { showNotify(`解析失敗: ${err.message}`, "error"); } finally { setLoading(false); }
    }

    // --- Calendar UI ---
    function renderCalendar() {
        const grid = getEl('calendarGrid'); grid.innerHTML = '';
        const year = currentDate.getFullYear(); const month = currentDate.getMonth();
        getEl('currentMonthDisplay').textContent = `${year}年 ${month + 1}月`;
        const firstIdx = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const prevLastDate = new Date(year, month, 0).getDate();

        for (let i = firstIdx; i > 0; i--) createDayCell(new Date(year, month - 1, prevLastDate - i + 1), true);
        for (let i = 1; i <= lastDate; i++) createDayCell(new Date(year, month, i), false);
        const remaining = (7 - ((firstIdx + lastDate) % 7)) % 7;
        for (let i = 1; i <= remaining; i++) { grid.appendChild(document.createElement('div')); }
    }

    function createDayCell(dateObj, isDimmed) {
        const grid = getEl('calendarGrid');
        const cell = document.createElement('div');
        const day = dateObj.getDate();
        const dateKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = new Date().toDateString() === dateObj.toDateString();
        const holidayName = getHolidayName(dateObj);
        
        cell.className = `day-card ${isDimmed ? 'opacity-40 pointer-events-none' : ''} ${isToday ? 'today' : ''} ${selectedDateStr === dateKey ? 'selected' : ''} ${holidayName ? 'holiday' : ''}`;
        
        const label = document.createElement('span');
        label.className = `day-num`;
        label.textContent = day;
        cell.appendChild(label);

        if (holidayName && !isDimmed) {
            const hLabel = document.createElement('span');
            hLabel.className = 'text-[8px] text-red-500 font-bold mb-1 truncate block';
            hLabel.textContent = holidayName;
            cell.appendChild(hLabel);
        }
        
        const list = document.createElement('div');
        list.className = 'flex flex-col gap-1 w-full flex-grow';
        if (!isDimmed) {
            cell.onclick = () => { 
                selectedDateStr = dateKey; renderCalendar(); updateDayDetail(dateKey); 
                const panel = getEl('dayDetailPanel');
                if(window.innerWidth < 768) { panel.classList.remove('translate-y-full'); } else { panel.classList.remove('md:translate-x-full'); }
            };
            events.filter(e => e.date === dateKey).slice(0, 4).forEach(ev => {
                const chip = document.createElement('div'); chip.className = 'event-pill'; chip.textContent = ev.title; list.appendChild(chip);
            });
        }
        cell.appendChild(list); grid.appendChild(cell);
    }

    function updateDayDetail(dateStr) {
        const listEl = getEl('detailEventList');
        const [y, m, d] = dateStr.split('-').map(Number);
        const dateObj = new Date(y, m - 1, d);
        getEl('detailDateDisplay').textContent = `${m}月${d}日`;
        let dayText = dateObj.toLocaleDateString('ja-JP', {weekday:'long'});
        const hol = getHolidayName(dateObj);
        if (hol) dayText += ` (${hol})`;
        getEl('detailDayOfWeek').textContent = dayText;

        const dayEvents = events.filter(e => e.date === dateStr).sort((a,b)=>(a.time||'23:59').localeCompare(b.time||'23:59'));
        
        listEl.innerHTML = '';
        if(dayEvents.length === 0) listEl.innerHTML = `<div class="flex flex-col items-center justify-center h-48 text-slate-400/50"><i class="fas fa-mug-hot text-4xl mb-3"></i><p class="text-xs font-bold">No Events</p></div>`;

        dayEvents.forEach(ev => {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition group';
            card.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <span class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md">${ev.time || 'ALL DAY'}</span>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                        <button class="w-7 h-7 rounded-full bg-slate-50 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 flex items-center justify-center edit-btn"><i class="fas fa-pen text-[10px]"></i></button>
                        <button class="w-7 h-7 rounded-full bg-slate-50 text-slate-400 hover:text-red-500 hover:bg-red-50 flex items-center justify-center del-btn"><i class="fas fa-trash text-[10px]"></i></button>
                    </div>
                </div>
                <h4 class="font-bold text-slate-800 text-base mb-1">${ev.title}</h4>
                ${ev.description ? `<p class="text-xs text-slate-500 leading-relaxed">${ev.description}</p>` : ''}
            `;
            card.querySelector('.edit-btn').onclick = () => openEventForm(ev.id);
            card.querySelector('.del-btn').onclick = () => { if(confirm(`削除しますか？`)) deleteEvent(ev.id); };
            listEl.appendChild(card);
        });
    }

    // --- Modal Controls & Listeners ---
    function openEventForm(id = null) {
        getEl('formEventId').value = id || "";
        if (id) {
            const ev = events.find(e => e.id === id);
            getEl('formTitle').value = ev.title;
            getEl('formDate').value = ev.date;
            getEl('formTime').value = ev.time || "";
            getEl('formDescription').value = ev.description || "";
        } else {
            getEl('eventForm').reset();
            getEl('formDate').value = selectedDateStr || "";
        }
        showModal('eventFormModal');
    }

    getEl('eventForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = getEl('formEventId').value;
        const data = {
            title: getEl('formTitle').value,
            date: getEl('formDate').value,
            time: getEl('formTime').value,
            description: getEl('formDescription').value,
            updatedAt: serverTimestamp()
        };
        try {
            setLoading(true, "Saving...");
            if (id) await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'events', id), data, {merge:true});
            else { data.createdAt = serverTimestamp(); await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'events'), data); }
            hideModal('eventFormModal');
            showNotify("Saved", "success");
        } catch (err) { showNotify(err.message, "error"); } finally { setLoading(false); }
    };

    getEl('loginBtn').onclick = getEl('loginBtnLarge').onclick = () => signInWithPopup(auth, provider).catch(e => {
        if(e.code === 'auth/unauthorized-domain') {
            const em = getEl('authErrorMessage');
            em.innerHTML = "エラー: Firebaseコンソールでこのドメインを許可してください。";
            em.classList.remove('hidden');
        }
    });
    getEl('logoutBtn').onclick = () => signOut(auth);
    getEl('prevBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); };
    getEl('nextBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); };
    getEl('closeDetail').onclick = () => {
        const panel = getEl('dayDetailPanel');
        panel.classList.add('md:translate-x-full', 'translate-y-full');
    };
    getEl('manualAddBtn').onclick = () => openEventForm();
    getEl('closeEventForm').onclick = () => hideModal('eventFormModal');
    getEl('openSettings').onclick = () => { getEl('apiKeyInput').value = geminiKey; showModal('settingsModal'); };
    getEl('closeSettings').onclick = () => hideModal('settingsModal');
    getEl('notificationToggle').onchange = (e) => {
        if (e.target.checked) requestNotifyPermission();
        else { notificationsEnabled = false; localStorage.setItem('v21_notify', 'false'); }
    };
    getEl('discoverBtn').onclick = async () => {
        setLoading(true);
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${geminiKey}`);
            const data = await res.json();
            const select = getEl('modelSelect'); select.innerHTML = '';
            data.models.filter(m => m.supportedGenerationMethods.includes("generateContent")).forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.name.split('/').pop(); opt.textContent = opt.value;
                if(opt.value === geminiModel) opt.selected = true;
                select.appendChild(opt);
            });
            showNotify("Models Updated", "success");
        } catch(e) { showNotify("Failed", "error"); } finally { setLoading(false); }
    };
    getEl('saveSettings').onclick = () => {
        geminiKey = getEl('apiKeyInput').value.trim();
        geminiModel = getEl('modelSelect').value;
        localStorage.setItem('v21_key', geminiKey); localStorage.setItem('v21_model', geminiModel);
        showNotify("Saved", "success"); hideModal('settingsModal');
    };
    const closeAiModalHandler = () => { hideModal('aiModal'); getEl('previewArea').classList.add('hidden'); getEl('dropZone').classList.remove('hidden'); };
    getEl('openAiModal').onclick = () => showModal('aiModal');
    getEl('closeAiModal').onclick = getEl('cancelUpload').onclick = closeAiModalHandler;
    getEl('dropZone').onclick = () => getEl('fileInput').click();
    getEl('fileInput').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const r = new FileReader(); r.onload = (ev) => {
                getEl('imagePreview').src = ev.target.result;
                getEl('previewArea').classList.remove('hidden');
                getEl('dropZone').classList.add('hidden');
                getEl('processAiBtn').disabled = false;
                window._lastImg = ev.target.result;
            }; r.readAsDataURL(file);
        }
    };
    getEl('processAiBtn').onclick = () => { if(window._lastImg) analyzeImage(window._lastImg); };
    async function deleteEvent(id) { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'events', id)); showNotify("Deleted", "success"); }
    function setLoading(is, msg) { if (msg) getEl('loadingMessage').textContent = msg; getEl('loadingOverlay').classList.toggle('hidden', !is); }
    function showNotify(txt, type) {
        const n = getEl('notification');
        getEl('notifyText').textContent = txt;
        const icon = getEl('notifyIcon');
        n.className = `fixed top-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl z-[100] flex items-center space-x-3 min-w-[300px] text-white transition-all duration-300 ${type==='success'?'bg-emerald-500':'bg-rose-500'}`;
        icon.innerHTML = type==='success'?'<i class="fas fa-check"></i>':'<i class="fas fa-exclamation"></i>';
        n.classList.remove('translate-y-[-150%]', 'opacity-0');
        setTimeout(() => n.classList.add('translate-y-[-150%]', 'opacity-0'), 4000);
    }

    renderCalendar();
</script>
</body>
</html>