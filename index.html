<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Calendar - Holiday & Notify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; overflow: hidden; }
        
        /* Grid */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid #e2e8f0; border-left: 1px solid #e2e8f0; background-color: white; }
        .day-cell { min-height: 100px; height: calc((100vh - 160px) / 5.5); display: flex; flex-direction: column; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; padding: 8px; cursor: pointer; transition: background-color 0.1s; position: relative; }
        @media (max-width: 768px) { .day-cell { height: calc((100vh - 240px) / 6); padding: 4px; min-height: 80px; } }
        .day-cell:hover { background-color: #f1f5f9; }
        .day-cell.selected { background-color: #eef2ff; }
        .today { background-color: #f8fafc; }
        
        /* Date Numbers */
        .day-num { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; color: #64748b; margin-bottom: 4px; border-radius: 50%; }
        .today .day-num { background-color: #3b82f6; color: white; }
        
        /* Holidays & Sundays */
        .holiday .day-num, .sunday .day-num { color: #ef4444; }
        .saturday .day-num { color: #3b82f6; }
        .holiday { background-color: #fef2f2; }
        
        /* Event Chips */
        .event-chip { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background-color: #e0e7ff; color: #4338ca; font-weight: 500; }
        
        .custom-scroll::-webkit-scrollbar { display: none; }
        .loading-overlay { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); z-index: 50; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden">

    <!-- Sidebar (PC) -->
    <nav class="bg-white border-r border-slate-200 w-16 flex flex-col items-center py-6 hidden md:flex z-20">
        <div class="text-indigo-600 mb-8"><i class="fas fa-calendar-check text-2xl"></i></div>
        <div class="flex flex-col gap-6 w-full items-center">
            <button id="navCalendar" class="text-indigo-600 w-10 h-10 flex items-center justify-center rounded-lg bg-indigo-50 transition"><i class="fas fa-calendar-alt text-lg"></i></button>
            <button id="openAiModal" class="text-slate-400 hover:text-slate-600 w-10 h-10 flex items-center justify-center rounded-lg transition disabled:opacity-30" disabled><i class="fas fa-magic text-lg"></i></button>
            <button id="openSettings" class="text-slate-400 hover:text-slate-600 w-10 h-10 flex items-center justify-center rounded-lg transition"><i class="fas fa-cog text-lg"></i></button>
        </div>
        <div class="flex-grow"></div>
        <div id="authAreaPC" class="flex flex-col gap-4 items-center">
            <button id="loginBtnPC" class="text-slate-400 hover:text-indigo-600"><i class="fas fa-sign-in-alt text-lg"></i></button>
            <div id="userProfilePC" class="hidden flex flex-col items-center gap-4">
                <button id="logoutBtnPC" class="text-slate-400 hover:text-red-500"><i class="fas fa-power-off text-sm"></i></button>
                <img id="userPhotoPC" src="" class="w-8 h-8 rounded-full border border-slate-200" alt="U">
            </div>
        </div>
    </nav>

    <!-- Mobile Bottom Nav -->
    <nav class="md:hidden fixed bottom-0 w-full bg-white border-t border-slate-200 flex justify-around items-center h-16 z-50 px-4 safe-pb">
        <button id="navCalendarMob" class="text-indigo-600"><i class="fas fa-calendar-alt text-xl"></i></button>
        <button id="openAiModalMob" class="text-slate-400 disabled:opacity-30" disabled><i class="fas fa-magic text-xl"></i></button>
        <button id="openSettingsMob" class="text-slate-400"><i class="fas fa-cog text-xl"></i></button>
        <button id="loginBtnMob" class="text-slate-400"><i class="fas fa-sign-in-alt text-xl"></i></button>
        <div id="userProfileMob" class="hidden"><img id="userPhotoMob" src="" class="w-8 h-8 rounded-full border border-slate-200"></div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col md:flex-row relative h-full w-full pb-16 md:pb-0 overflow-hidden">
        
        <!-- Calendar Section -->
        <div id="calendarArea" class="flex-grow flex flex-col h-full bg-white relative z-0">
            <!-- Header -->
            <div class="px-6 py-4 flex items-center justify-between border-b border-slate-100">
                <div class="flex items-center gap-4">
                    <h2 id="currentMonthDisplay" class="text-xl font-bold text-slate-800"></h2>
                    <div class="flex gap-1">
                        <button id="prevBtn" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-500"><i class="fas fa-chevron-left text-sm"></i></button>
                        <button id="nextBtn" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-500"><i class="fas fa-chevron-right text-sm"></i></button>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="notificationToggleBtn" class="text-slate-300 hover:text-indigo-500 transition" title="通知設定"><i class="fas fa-bell"></i></button>
                    <span id="activeModelBadge" class="text-xs text-slate-400 font-medium border px-2 py-0.5 rounded">Detecting...</span>
                </div>
            </div>

            <!-- Login Prompt -->
            <div id="loginPrompt" class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm hidden">
                <div class="text-center p-6 max-w-sm">
                    <div class="mb-4 text-indigo-500"><i class="fas fa-lock text-3xl"></i></div>
                    <h3 class="text-lg font-bold text-slate-800 mb-2">ログインが必要です</h3>
                    <p class="text-sm text-slate-500 mb-4">カレンダーの同期とAI機能を利用するにはGoogleアカウントでログインしてください。</p>
                    <button id="loginBtnLarge" class="bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-medium shadow-sm hover:bg-indigo-700 transition">Googleでログイン</button>
                    <!-- Error Message Area -->
                    <div id="authErrorMessage" class="hidden mt-4 p-3 bg-red-50 text-red-600 text-xs text-left rounded-lg border border-red-100"></div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendarWrapper" class="flex-grow flex flex-col overflow-hidden hidden">
                <div class="grid grid-cols-7 text-center py-2 border-b border-slate-200 bg-slate-50">
                    <div class="text-xs font-semibold text-red-500">日</div>
                    <div class="text-xs font-semibold text-slate-500">月</div>
                    <div class="text-xs font-semibold text-slate-500">火</div>
                    <div class="text-xs font-semibold text-slate-500">水</div>
                    <div class="text-xs font-semibold text-slate-500">木</div>
                    <div class="text-xs font-semibold text-slate-500">金</div>
                    <div class="text-xs font-semibold text-blue-500">土</div>
                </div>
                <div id="calendarGrid" class="calendar-grid overflow-y-auto custom-scroll h-full"></div>
            </div>
        </div>

        <!-- Detail Panel -->
        <aside id="dayDetailPanel" class="w-full md:w-80 bg-white border-l border-slate-200 z-10 flex flex-col transition-transform duration-300 transform translate-y-full md:translate-y-0 md:translate-x-full fixed md:absolute top-0 right-0 h-full shadow-xl md:shadow-none">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                <div>
                    <h3 id="detailDateDisplay" class="text-xl font-bold text-slate-800">日付を選択</h3>
                    <p id="detailDayOfWeek" class="text-sm text-slate-400 mt-1">--</p>
                </div>
                <button id="closeDetail" class="text-slate-400 hover:text-slate-600 p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="detailEventList" class="flex-grow p-4 space-y-3 overflow-y-auto custom-scroll bg-slate-50">
                <div class="flex flex-col items-center justify-center h-40 text-slate-400">
                    <p class="text-sm">日付を選択してください</p>
                </div>
            </div>
            <div class="p-4 bg-white border-t border-slate-200 safe-pb">
                <button id="manualAddBtn" class="w-full py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> 追加
                </button>
            </div>
        </aside>
    </main>

    <!-- Modals -->
    <!-- AI Modal -->
    <div id="aiModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800">AI解析</h3>
                <button id="closeAiModal" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-indigo-500 hover:bg-indigo-50 transition cursor-pointer">
                <input type="file" id="fileInput" class="hidden" accept="image/*">
                <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-2"></i>
                <p class="text-sm text-slate-600">画像をアップロード</p>
            </div>
            <div id="previewArea" class="mt-4 hidden text-center">
                <img id="imagePreview" src="" class="rounded-lg w-full max-h-48 object-contain border border-slate-200">
            </div>
            <div class="mt-6 flex gap-3">
                <button id="cancelUpload" class="flex-1 py-2.5 text-slate-500 font-medium hover:bg-slate-100 rounded-lg transition">キャンセル</button>
                <button id="processAiBtn" class="flex-1 py-2.5 bg-indigo-600 text-white font-medium rounded-lg disabled:opacity-50 transition" disabled>解析開始</button>
            </div>
        </div>
    </div>

    <!-- Event Form Modal -->
    <div id="eventFormModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-lg font-bold text-slate-800 mb-4">予定の編集</h3>
            <form id="eventForm" class="space-y-4">
                <input type="hidden" id="formEventId">
                <div>
                    <label class="text-xs font-bold text-slate-500 block mb-1">タイトル</label>
                    <input type="text" id="formTitle" required class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg outline-none focus:border-indigo-500">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">日付</label>
                        <input type="date" id="formDate" required class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">時刻</label>
                        <input type="time" id="formTime" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg outline-none focus:border-indigo-500">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 block mb-1">詳細</label>
                    <textarea id="formDescription" rows="3" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg outline-none focus:border-indigo-500 resize-none"></textarea>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" id="closeEventForm" class="flex-1 py-2 text-slate-500 font-medium hover:bg-slate-100 rounded-lg transition">キャンセル</button>
                    <button type="submit" class="flex-1 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-lg font-bold text-slate-800 mb-4">設定</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 block mb-1">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg outline-none focus:border-indigo-500 text-sm">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 block mb-1">Model</label>
                    <div class="flex gap-2">
                        <select id="modelSelect" class="flex-grow px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg text-sm outline-none focus:border-indigo-500">
                            <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                            <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
                        </select>
                        <button id="discoverBtn" class="bg-slate-100 text-indigo-600 w-10 rounded-lg border border-slate-200 hover:bg-slate-200"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <div class="flex items-center justify-between pt-2">
                    <label class="text-sm font-bold text-slate-700">通知機能</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="notificationToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="notificationToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                    <style>
                        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
                        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
                        .toggle-checkbox { right: 50%; border-color: gray; transition: all 0.3s; }
                    </style>
                </div>
                <div class="flex gap-3 pt-2">
                    <button id="closeSettings" class="flex-1 py-2 text-slate-500 font-medium hover:bg-slate-100 rounded-lg transition">閉じる</button>
                    <button id="saveSettings" class="flex-1 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loadingOverlay" class="fixed inset-0 loading-overlay flex items-center justify-center hidden">
        <div class="bg-white px-8 py-6 rounded-xl shadow-lg border border-slate-100 flex flex-col items-center">
            <i class="fas fa-circle-notch spinner text-2xl text-indigo-600 mb-2"></i>
            <p id="loadingMessage" class="text-sm font-bold text-slate-600">Processing...</p>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg translate-y-[-150%] opacity-0 transition-all duration-300 z-[100] flex items-center space-x-2 min-w-[200px] bg-slate-800 text-white">
        <div id="notifyIcon"></div>
        <p id="notifyText" class="text-sm"></p>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyA9MeRV2VefKb5cOJLzegq3U6EsBEB2axg",
        authDomain: "my-ai-calender-68d05.firebaseapp.com",
        projectId: "my-ai-calender-68d05",
        storageBucket: "my-ai-calender-68d05.firebasestorage.app",
        messagingSenderId: "591169343842",
        appId: "1:591169343842:web:4345e3fdff52d4b5cadc3b"
    };
    const appId = "calendar-simple-v20";

    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);
    const provider = new GoogleAuthProvider();

    let user = null, events = [], currentDate = new Date(), selectedDateStr = null, unsubscribe = null;
    let geminiKey = localStorage.getItem('v20_key') || "", geminiModel = localStorage.getItem('v20_model') || "gemini-1.5-flash";
    let notificationsEnabled = localStorage.getItem('v20_notify') === 'true'; // Default true if set, else false initially but UI defaults to true logic

    const getEl = (id) => document.getElementById(id);
    const toggleClass = (id, cls, condition) => getEl(id).classList.toggle(cls, condition);
    const showModal = (id) => getEl(id).classList.remove('hidden');
    const hideModal = (id) => getEl(id).classList.add('hidden');

    // --- Holiday Logic (Simple Calculation for Japan) ---
    function getHolidayName(date) {
        const y = date.getFullYear(), m = date.getMonth() + 1, d = date.getDate();
        const w = date.getDay(); // 0:Sun
        
        // Fixed Holidays
        if (m==1 && d==1) return "元日";
        if (m==2 && d==11) return "建国記念の日";
        if (m==2 && d==23) return "天皇誕生日";
        if (m==4 && d==29) return "昭和の日";
        if (m==5 && d==3) return "憲法記念日";
        if (m==5 && d==4) return "みどりの日";
        if (m==5 && d==5) return "こどもの日";
        if (m==8 && d==11) return "山の日";
        if (m==11 && d==3) return "文化の日";
        if (m==11 && d==23) return "勤労感謝の日";

        // Happy Monday
        const nth = Math.floor((d - 1) / 7) + 1;
        if (m==1 && nth==2 && w==1) return "成人の日";
        if (m==7 && nth==3 && w==1) return "海の日";
        if (m==9 && nth==3 && w==1) return "敬老の日";
        if (m==10 && nth==2 && w==1) return "スポーツの日";

        // Equinox (Approximate)
        const vernal = Math.floor(20.8431 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4));
        const autumnal = Math.floor(23.2488 + 0.242194 * (y - 1980) - Math.floor((y - 1980) / 4));
        if (m==3 && d==vernal) return "春分の日";
        if (m==9 && d==autumnal) return "秋分の日";

        return null;
    }

    // --- Notification Logic ---
    function checkNotifications() {
        if (!notificationsEnabled || !user) return;
        const now = new Date();
        const currentHour = now.getHours();
        const currentMin = now.getMinutes();
        const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

        // 1. Morning Notification (06:30)
        if (currentHour === 6 && currentMin === 30) {
            const todayEvents = events.filter(e => e.date === todayStr);
            if (todayEvents.length > 0 && !hasNotified(`morning_${todayStr}`)) {
                sendNotification(`今日の予定: ${todayEvents.length}件`, todayEvents.map(e => `・${e.time||''} ${e.title}`).join('\n'));
                markNotified(`morning_${todayStr}`);
            }
        }

        // 2. Event Reminder (1h & 10min before)
        events.forEach(ev => {
            if (ev.date === todayStr && ev.time) {
                const [h, m] = ev.time.split(':').map(Number);
                const eventTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m);
                const diffMin = (eventTime - now) / 1000 / 60;

                // 1 hour before (59-61 min)
                if (diffMin >= 59 && diffMin <= 61 && !hasNotified(`1h_${ev.id}`)) {
                    sendNotification(`1時間前: ${ev.title}`, ev.description || "");
                    markNotified(`1h_${ev.id}`);
                }
                // 10 min before (9-11 min)
                if (diffMin >= 9 && diffMin <= 11 && !hasNotified(`10m_${ev.id}`)) {
                    sendNotification(`まもなく開始: ${ev.title}`, "10分前です");
                    markNotified(`10m_${ev.id}`);
                }
            }
        });
    }

    function sendNotification(title, body) {
        if (Notification.permission === 'granted') {
            new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/2693/2693507.png' });
        }
    }

    const notifiedSet = new Set(); // In-memory cache for current session
    function hasNotified(key) { return notifiedSet.has(key); }
    function markNotified(key) { notifiedSet.add(key); }

    // Request Permission
    function requestNotifyPermission() {
        if (!('Notification' in window)) return alert("このブラウザは通知に対応していません");
        Notification.requestPermission().then(p => {
            if(p === 'granted') {
                notificationsEnabled = true;
                localStorage.setItem('v20_notify', 'true');
                getEl('notificationToggle').checked = true;
                showNotify("通知をONにしました", "success");
            } else {
                notificationsEnabled = false;
                localStorage.setItem('v20_notify', 'false');
                getEl('notificationToggle').checked = false;
                alert("通知がブロックされています。ブラウザの設定を確認してください。");
            }
        });
    }

    // Loop
    setInterval(checkNotifications, 60000); // Check every minute

    // --- Main Logic ---
    onAuthStateChanged(auth, (u) => {
        user = u; updateUI();
        if (user) syncData();
        else { if (unsubscribe) unsubscribe(); renderCalendar(); }
    });

    function updateUI() {
        const loggedIn = !!user;
        toggleClass('loginPrompt', 'hidden', loggedIn);
        toggleClass('calendarWrapper', 'hidden', !loggedIn);
        getEl('openAiModal').disabled = !loggedIn;
        getEl('openAiModalMob').disabled = !loggedIn;
        toggleClass('loginBtnPC', 'hidden', loggedIn);
        toggleClass('userProfilePC', 'hidden', !loggedIn);
        if (user) getEl('userPhotoPC').src = user.photoURL;
        toggleClass('loginBtnMob', 'hidden', loggedIn);
        toggleClass('userProfileMob', 'hidden', !loggedIn);
        if (user) getEl('userPhotoMob').src = user.photoURL;
        getEl('activeModelBadge').textContent = geminiModel;
        
        // Initial Toggle State
        if (localStorage.getItem('v20_notify') === null) {
            // Default ON if not set
            notificationsEnabled = true;
            getEl('notificationToggle').checked = true;
        } else {
            getEl('notificationToggle').checked = notificationsEnabled;
        }
    }

    function syncData() {
        if (!user) return;
        unsubscribe = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'events'), (snap) => {
            events = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderCalendar();
            if (selectedDateStr) updateDayDetail(selectedDateStr);
        }, (error) => {
            if (error.code === 'auth/unauthorized-domain') {
                const errMsg = getEl('authErrorMessage');
                errMsg.innerHTML = `<strong>設定エラー:</strong><br>Firebase Consoleでこのドメイン (${window.location.hostname}) を承認済みドメインに追加してください。<br>(Authentication > Settings > Authorized domains)`;
                errMsg.classList.remove('hidden');
            }
        });
    }

    // --- AI Logic ---
    async function analyzeImage(base64) {
        if (!geminiKey) return showNotify("APIキーを設定してください", "error");
        setLoading(true, "解析中...");
        const prompt = `画像からカレンダー予定を抽出しJSON形式で返してください: [{"title": "件名", "date": "YYYY-MM-DD", "time": "HH:mm", "description": ""}]。`;
        try {
            const path = geminiModel.startsWith('models/') ? geminiModel : `models/${geminiModel}`;
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/${path}:generateContent?key=${geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64.split(',')[1] } }] }] })
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            const items = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```json|```/g, "").trim());
            for (const item of items) if (item.title && item.date) await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'events'), { ...item, createdAt: serverTimestamp() });
            showNotify(`${items.length}件登録しました`, "success");
            hideModal('aiModal'); resetAiModal();
        } catch (err) { showNotify(`解析失敗: ${err.message}`, "error"); } finally { setLoading(false); }
    }

    // --- Calendar UI ---
    function renderCalendar() {
        const grid = getEl('calendarGrid'); grid.innerHTML = '';
        const year = currentDate.getFullYear(); const month = currentDate.getMonth();
        getEl('currentMonthDisplay').textContent = `${year}年 ${month + 1}月`;
        const firstIdx = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const prevLastDate = new Date(year, month, 0).getDate();

        for (let i = firstIdx; i > 0; i--) createDayCell(new Date(year, month - 1, prevLastDate - i + 1), true);
        for (let i = 1; i <= lastDate; i++) createDayCell(new Date(year, month, i), false);
        const remaining = (7 - ((firstIdx + lastDate) % 7)) % 7;
        for (let i = 1; i <= remaining; i++) { grid.appendChild(document.createElement('div')); }
    }

    function createDayCell(dateObj, isDimmed) {
        const grid = getEl('calendarGrid');
        const cell = document.createElement('div');
        const day = dateObj.getDate();
        const dateKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = new Date().toDateString() === dateObj.toDateString();
        
        // Holiday Check
        const holidayName = getHolidayName(dateObj);
        const isHoliday = !!holidayName;
        const dayOfWeek = dateObj.getDay(); // 0:Sun, 6:Sat

        let classList = `day-cell ${isDimmed ? 'opacity-30 pointer-events-none' : ''} ${isToday ? 'today' : ''} ${selectedDateStr === dateKey ? 'selected' : ''}`;
        if (isHoliday) classList += ' holiday';
        else if (dayOfWeek === 0) classList += ' sunday';
        else if (dayOfWeek === 6) classList += ' saturday';

        cell.className = classList;
        
        const label = document.createElement('span');
        label.className = `day-num`;
        label.textContent = day;
        cell.appendChild(label);

        if (isHoliday && !isDimmed) {
            const holLabel = document.createElement('span');
            holLabel.className = 'text-[8px] text-red-500 font-bold mb-1 block truncate';
            holLabel.textContent = holidayName;
            cell.appendChild(holLabel);
        }
        
        const list = document.createElement('div');
        list.className = 'flex flex-col gap-1 w-full flex-grow';
        if (!isDimmed) {
            cell.onclick = () => { 
                selectedDateStr = dateKey; 
                renderCalendar(); 
                updateDayDetail(dateKey); 
                const panel = getEl('dayDetailPanel');
                if(window.innerWidth < 768) { panel.classList.remove('translate-y-full'); } else { panel.classList.remove('md:translate-x-full'); }
            };
            events.filter(e => e.date === dateKey).slice(0, 4).forEach(ev => {
                const chip = document.createElement('div'); chip.className = 'event-chip'; chip.textContent = ev.title; list.appendChild(chip);
            });
        }
        cell.appendChild(list); grid.appendChild(cell);
    }

    function updateDayDetail(dateStr) {
        const listEl = getEl('detailEventList');
        const [y, m, d] = dateStr.split('-').map(Number);
        const dateObj = new Date(y, m - 1, d);
        getEl('detailDateDisplay').textContent = `${m}月${d}日`;
        getEl('detailDayOfWeek').textContent = dateObj.toLocaleDateString('ja-JP', {weekday:'long'});
        
        const hol = getHolidayName(dateObj);
        if (hol) getEl('detailDayOfWeek').textContent += ` (${hol})`;

        const dayEvents = events.filter(e => e.date === dateStr).sort((a,b)=>(a.time||'23:59').localeCompare(b.time||'23:59'));
        
        listEl.innerHTML = '';
        if(dayEvents.length === 0) {
            listEl.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-300"><i class="fas fa-calendar-times text-2xl mb-2"></i><p class="text-xs">予定なし</p></div>`;
        }

        dayEvents.forEach(ev => {
            const card = document.createElement('div');
            card.className = 'bg-white p-3 rounded-lg shadow-sm border border-slate-100 hover:border-indigo-200 transition group';
            card.innerHTML = `
                <div class="flex items-start justify-between mb-1">
                    <span class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">${ev.time || 'ALL DAY'}</span>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                        <button class="text-slate-400 hover:text-indigo-600 edit-btn"><i class="fas fa-pen text-xs"></i></button>
                        <button class="text-slate-400 hover:text-red-500 del-btn"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>
                <h4 class="font-bold text-slate-800 text-sm">${ev.title}</h4>
                ${ev.description ? `<p class="text-xs text-slate-500 mt-1">${ev.description}</p>` : ''}
            `;
            card.querySelector('.edit-btn').onclick = () => openEventForm(ev.id);
            card.querySelector('.del-btn').onclick = () => { if(confirm(`削除しますか？`)) deleteEvent(ev.id); };
            listEl.appendChild(card);
        });
    }

    // --- Modal Controls ---
    const modalEl = getEl('eventFormModal');
    function openEventForm(id = null) {
        getEl('formEventId').value = id || "";
        if (id) {
            const ev = events.find(e => e.id === id);
            getEl('formTitle').value = ev.title;
            getEl('formDate').value = ev.date;
            getEl('formTime').value = ev.time || "";
            getEl('formDescription').value = ev.description || "";
        } else {
            getEl('eventForm').reset();
            getEl('formDate').value = selectedDateStr || "";
        }
        showModal('eventFormModal');
    }
    
    function closeEventFormHandler() { hideModal('eventFormModal'); }

    getEl('eventForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = getEl('formEventId').value;
        const data = {
            title: getEl('formTitle').value,
            date: getEl('formDate').value,
            time: getEl('formTime').value,
            description: getEl('formDescription').value,
            updatedAt: serverTimestamp()
        };
        try {
            setLoading(true);
            if (id) await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'events', id), data, {merge:true});
            else { data.createdAt = serverTimestamp(); await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'events'), data); }
            hideModal('eventFormModal');
            showNotify("Saved", "success");
        } catch (err) { showNotify(err.message, "error"); } finally { setLoading(false); }
    };

    // --- Handlers ---
    const login = () => signInWithPopup(auth, provider).catch(error => {
        if(error.code === 'auth/unauthorized-domain') {
            const errMsg = getEl('authErrorMessage');
            errMsg.innerHTML = `<strong>設定エラー:</strong><br>Firebase Consoleでこのドメインを承認済みドメインに追加してください。<br>(Authentication > Settings > Authorized domains)`;
            errMsg.classList.remove('hidden');
        } else {
            showNotify(error.message, 'error');
        }
    });
    const logout = () => signOut(auth);
    
    getEl('loginBtnPC').onclick = login; getEl('loginBtnMob').onclick = login; getEl('loginBtnLarge').onclick = login;
    getEl('logoutBtnPC').onclick = logout;
    getEl('prevBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); };
    getEl('nextBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); };
    
    getEl('closeDetail').onclick = () => {
        const panel = getEl('dayDetailPanel');
        panel.classList.add('md:translate-x-full');
        panel.classList.add('translate-y-full');
    };
    getEl('manualAddBtn').onclick = () => openEventForm();
    getEl('closeEventForm').onclick = closeEventFormHandler;
    
    const settingsHandler = () => { 
        getEl('apiKeyInput').value = geminiKey; 
        getEl('notificationToggle').checked = notificationsEnabled;
        showModal('settingsModal'); 
    };
    getEl('openSettings').onclick = settingsHandler; getEl('openSettingsMob').onclick = settingsHandler;
    getEl('closeSettings').onclick = () => hideModal('settingsModal');
    
    getEl('notificationToggle').onchange = (e) => {
        if (e.target.checked) {
            requestNotifyPermission();
        } else {
            notificationsEnabled = false;
            localStorage.setItem('v20_notify', 'false');
        }
    };

    getEl('discoverBtn').onclick = async () => {
        setLoading(true);
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${geminiKey}`);
            const data = await res.json();
            const select = getEl('modelSelect'); select.innerHTML = '';
            data.models.filter(m => m.supportedGenerationMethods.includes("generateContent")).forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.name.split('/').pop(); opt.textContent = opt.value;
                if(opt.value === geminiModel) opt.selected = true;
                select.appendChild(opt);
            });
            showNotify("Models Updated", "success");
        } catch(e) { showNotify("Failed", "error"); } finally { setLoading(false); }
    };
    getEl('saveSettings').onclick = () => {
        geminiKey = getEl('apiKeyInput').value.trim();
        geminiModel = getEl('modelSelect').value;
        localStorage.setItem('v20_key', geminiKey); localStorage.setItem('v20_model', geminiModel);
        showNotify("Saved", "success"); hideModal('settingsModal');
    };

    const aiHandler = () => showModal('aiModal');
    getEl('openAiModal').onclick = aiHandler; getEl('openAiModalMob').onclick = aiHandler;
    const closeAiModalHandler = () => { hideModal('aiModal'); resetAiModal(); };
    getEl('closeAiModal').onclick = getEl('cancelUpload').onclick = closeAiModalHandler;
    getEl('dropZone').onclick = () => getEl('fileInput').click();
    getEl('fileInput').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const r = new FileReader(); r.onload = (ev) => {
                getEl('imagePreview').src = ev.target.result;
                getEl('previewArea').classList.remove('hidden');
                getEl('dropZone').classList.add('hidden');
                getEl('processAiBtn').disabled = false;
                window._lastImg = ev.target.result;
            }; r.readAsDataURL(file);
        }
    };
    getEl('processAiBtn').onclick = () => { if(window._lastImg) analyzeImage(window._lastImg); };
    function resetAiModal() { getEl('previewArea').classList.add('hidden'); getEl('dropZone').classList.remove('hidden'); }

    async function deleteEvent(id) { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'events', id)); showNotify("Deleted", "success"); }
    function setLoading(is, msg) { if (msg) getEl('loadingMessage').textContent = msg; getEl('loadingOverlay').classList.toggle('hidden', !is); }
    function showNotify(txt, type) {
        const n = getEl('notification');
        getEl('notifyText').textContent = txt;
        const icon = getEl('notifyIcon');
        n.className = `fixed top-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-lg z-[100] flex items-center space-x-3 min-w-[200px] text-white transition-all duration-300 ${type==='success'?'bg-emerald-500':'bg-red-500'}`;
        icon.innerHTML = type==='success'?'<i class="fas fa-check"></i>':'<i class="fas fa-exclamation"></i>';
        n.classList.remove('translate-y-[-150%]', 'opacity-0');
        setTimeout(() => n.classList.add('translate-y-[-150%]', 'opacity-0'), 4000);
    }

    renderCalendar();
</script>
</body>
</html>